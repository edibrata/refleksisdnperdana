<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Refleksi Komprehensif SDN Perdana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Pustaka Ekspor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        
        details summary::-webkit-details-marker { display:none; }
        details summary { list-style: none; }
        
        .card { background: white; border-radius: 1rem; border: 1px solid #e2e8f0; overflow: hidden; transition: all 0.3s ease; }
        .card-disabled { opacity: 0.6; pointer-events: none; background-color: #f1f5f9; }
        
        .input-field { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.6rem; outline: none; transition: all 0.2s; font-size: 0.875rem; resize: vertical; }
        .input-field:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        
        .char-hint { font-size: 0.7rem; color: #94a3b8; margin-top: 0.25rem; font-weight: 600; display: flex; justify-content: space-between; }
        .char-error { color: #ef4444 !important; }
        .char-success { color: #22c55e !important; }
        
        .tab-active { border-bottom: 3px solid #1e40af; color: #1e40af; font-weight: 700; }
        .tab-inactive { color: #64748b; }
        
        .sub-accordion { border: 1px solid #f1f5f9; border-radius: 0.75rem; margin-bottom: 0.5rem; transition: all 0.2s; }
        .sub-accordion[open] { border-color: #dbeafe; background-color: #fcfdfe; }
        .sub-disabled { opacity: 0.5; pointer-events: none; }
        
        .status-badge { display: flex; items-center: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; transition: all 0.3s; }
        .status-incomplete { background-color: #e2e8f0; color: #94a3b8; }
        .status-complete { background-color: #22c55e; color: white; }

        .hidden { display: none; }
        #login-modal { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); }
        .db-table-container { max-height: 700px; overflow: auto; }
        table thead th { position: sticky; top: 0; background: #f8fafc; z-index: 10; border-bottom: 2px solid #e2e8f0; }

        .ai-glow { animation: glow 2s infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px #3b82f6; } to { box-shadow: 0 0 20px #3b82f6; } }
        
        /* Typography for presentation */
        .presentation-text { font-size: 1.1rem; line-height: 1.7; color: #1e293b; font-weight: 400; }
        .presentation-title { font-size: 1.25rem; font-weight: 800; color: #0f172a; }
        .presentation-label { font-size: 0.75rem; font-weight: 800; color: #3b82f6; text-transform: uppercase; letter-spacing: 0.05em; }
    </style>
</head>
<body class="text-slate-800">

    <nav class="bg-white border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center space-x-2">
                    <div class="bg-blue-700 p-2 rounded-lg text-white shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <span class="font-bold text-lg tracking-tight">Refleksi 360° SDN Perdana</span>
                </div>
                <div class="flex items-center space-x-6 text-sm">
                    <button onclick="switchTab('form')" id="tab-form" class="tab-active py-5 transition-all">Formulir</button>
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-inactive py-5 transition-all">Analisis Kolektif</button>
                    <button onclick="switchTab('database')" id="tab-database" class="tab-inactive py-5 transition-all hidden">Database</button>
                    <button onclick="openLoginModal()" id="btn-login-admin" class="ml-4 px-3 py-1 bg-slate-100 text-slate-500 rounded-md hover:bg-slate-200 transition-colors text-xs font-bold uppercase tracking-wide">Login Admin</button>
                    <button onclick="logoutAdmin()" id="btn-logout-admin" class="ml-4 px-3 py-1 bg-red-50 text-red-600 rounded-md hover:bg-red-100 transition-colors text-xs font-bold uppercase hidden tracking-wide">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden p-8">
            <h3 class="text-xl font-bold text-slate-800 mb-6 text-center">Akses Administrator</h3>
            <div class="space-y-4">
                <div class="relative">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Password</label>
                    <input type="password" id="admin-password" class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none focus:border-blue-500" placeholder="••••••••">
                    <button onclick="togglePasswordVisibility()" class="absolute right-3 top-7 text-slate-400 hover:text-slate-600">
                        <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    </button>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="remember-me" class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                    <label for="remember-me" class="text-sm text-slate-600">Ingat Saya</label>
                </div>
                <div class="flex space-x-3 pt-2">
                    <button onclick="closeLoginModal()" class="flex-1 px-4 py-2 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-all">Batal</button>
                    <button onclick="processLogin()" class="flex-1 bg-blue-700 text-white px-4 py-2 rounded-xl font-bold hover:bg-blue-800 transition-all shadow-lg shadow-blue-100">Login</button>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-5xl mx-auto px-4 py-8">

        <!-- SECTION: FORMULIR -->
        <section id="content-form">
            <form id="masterForm" class="space-y-6 pb-20">
                <!-- BLOK 1-6 IDENTITAS SAMPAI KOMITMEN TETAP SAMA -->
                <details id="sec-1" class="card shadow-sm" open>
                    <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-slate-50 transition-colors list-none">
                        <div class="flex items-center space-x-4">
                            <div id="badge-1" class="status-badge status-incomplete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="icon-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" class="hidden" /><text x="7" y="17" font-size="14" font-weight="bold" fill="currentColor" id="num-1">1</text></svg>
                            </div>
                            <h2 class="font-bold text-slate-700">Identitas Pegawai</h2>
                        </div>
                    </summary>
                    <div class="p-6 pt-0 border-t border-slate-50">
                        <div class="max-w-md space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">Pilih Nama Anda</label>
                                <select id="user_name" class="input-field" required onchange="window.filterPeerReview()">
                                    <option value="">-- Pilih Nama --</option>
                                    <option>Neneng Imas Kurnia</option>
                                    <option>Ujang Edi Brata</option>
                                    <option>Asep Ruhbi</option>
                                    <option>Uju Juaenah</option>
                                    <option>Bahtiar Arifin</option>
                                    <option>Cupang Sulastri</option>
                                    <option>Kamjah</option>
                                    <option>Iis Isnayah</option>
                                    <option>Rini Lestari</option>
                                    <option>Novianti</option>
                                    <option>Ahmad Sanusi</option>
                                    <option>Samsudin</option>
                                </select>
                            </div>
                            <button type="button" onclick="window.validateAndNext(1)" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 transition-colors shadow-sm">Lanjut</button>
                        </div>
                    </div>
                </details>

                <details id="sec-2" class="card shadow-sm card-disabled">
                    <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-slate-50 transition-colors list-none">
                        <div class="flex items-center space-x-4">
                            <div id="badge-2" class="status-badge status-incomplete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="icon-2"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" class="hidden" /><text x="7" y="17" font-size="14" font-weight="bold" fill="currentColor" id="num-2">2</text></svg>
                            </div>
                            <h2 class="font-bold text-slate-700">Mimpi & Harapan Saya terhadap Sekolah</h2>
                        </div>
                    </summary>
                    <div class="p-6 pt-0 border-t border-slate-50 space-y-4">
                        <label class="block text-sm text-slate-600 mb-3 leading-relaxed font-medium">Tuangkan pandangan jujur Anda mengenai sekolah impian SDN Perdana.</label>
                        <div class="relative">
                            <textarea id="self_vision" class="input-field comp-input" rows="6" data-min="150" placeholder="Ceritakan cita-cita sekolah ideal..." required></textarea>
                            <div class="char-hint"><span>Minimal 150 Karakter</span><span class="char-count text-slate-400">0 / 150</span></div>
                        </div>
                        <button type="button" onclick="window.validateAndNext(2)" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 transition-colors shadow-sm">Lanjut</button>
                    </div>
                </details>

                <details id="sec-3" class="card shadow-sm card-disabled border-l-4 border-l-amber-400">
                    <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-slate-50 transition-colors list-none">
                        <div class="flex items-center space-x-4">
                            <div id="badge-3" class="status-badge status-incomplete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="icon-3"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" class="hidden" /><text x="7" y="17" font-size="14" font-weight="bold" fill="currentColor" id="num-3">3</text></svg>
                            </div>
                            <h2 class="font-bold text-slate-700">Kondisi Sekolah Saat Ini</h2>
                        </div>
                    </summary>
                    <div class="p-6 pt-0 border-t border-slate-50 space-y-4">
                        <details id="sub-3a" class="sub-accordion group" open>
                            <summary class="p-4 cursor-pointer list-none bg-emerald-50 rounded-t-lg font-bold text-emerald-700 uppercase text-xs">Aspek Positif</summary>
                            <div class="p-4 space-y-4 bg-white border border-emerald-100 rounded-b-lg">
                                <textarea id="cond_good" class="input-field comp-input" data-min="80" rows="3" placeholder="Hal baik..." required></textarea>
                                <textarea id="cond_good_indicator" class="input-field comp-input" data-min="80" rows="3" placeholder="Indikator..." required></textarea>
                                <textarea id="cond_good_cause" class="input-field comp-input" data-min="80" rows="3" placeholder="Penyebab..." required></textarea>
                                <button type="button" onclick="window.validateSub(3, 'a')" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-xs font-bold">Lanjut</button>
                            </div>
                        </details>
                        <details id="sub-3b" class="sub-accordion group sub-disabled">
                            <summary class="p-4 cursor-pointer list-none bg-rose-50 rounded-t-lg font-bold text-rose-700 uppercase text-xs">Aspek Buruk</summary>
                            <div class="p-4 space-y-4 bg-white border border-rose-100 rounded-b-lg">
                                <textarea id="cond_bad" class="input-field comp-input" data-min="80" rows="3" placeholder="Hal buruk..." required></textarea>
                                <textarea id="cond_bad_indicator" class="input-field comp-input" data-min="80" rows="3" placeholder="Indikator..." required></textarea>
                                <textarea id="cond_bad_cause" class="input-field comp-input" data-min="80" rows="3" placeholder="Penyebab..." required></textarea>
                                <button type="button" onclick="window.validateSub(3, 'b')" class="bg-rose-600 text-white px-4 py-2 rounded-lg text-xs font-bold">Selesai</button>
                            </div>
                        </details>
                        <div id="btn-sec-3-final" class="hidden pt-2"><button type="button" onclick="window.validateAndNext(3)" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-sm">Lanjut</button></div>
                    </div>
                </details>

                <details id="sec-4" class="card shadow-sm card-disabled">
                    <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-slate-50 transition-colors list-none">
                        <div class="flex items-center space-x-4">
                            <div id="badge-4" class="status-badge status-incomplete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="icon-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" class="hidden" /><text x="7" y="17" font-size="14" font-weight="bold" fill="currentColor" id="num-4">4</text></svg>
                            </div>
                            <h2 class="font-bold text-slate-700">Refleksi Kinerja Saya</h2>
                        </div>
                    </summary>
                    <div class="p-6 pt-0 border-t border-slate-50 space-y-6">
                        <textarea id="self_strength" class="input-field comp-input" data-min="100" rows="4" placeholder="Kelebihan..." required></textarea>
                        <textarea id="self_weakness" class="input-field comp-input" data-min="100" rows="4" placeholder="Kelemahan..." required></textarea>
                        <textarea id="self_effort" class="input-field comp-input" data-min="100" rows="4" placeholder="Upaya..." required></textarea>
                        <button type="button" onclick="window.validateAndNext(4)" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-sm">Lanjut</button>
                    </div>
                </details>

                <details id="sec-5" class="card shadow-sm card-disabled">
                    <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-slate-50 transition-colors list-none">
                        <div class="flex items-center space-x-4">
                            <div id="badge-5" class="status-badge status-incomplete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="icon-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" class="hidden" /><text x="7" y="17" font-size="14" font-weight="bold" fill="currentColor" id="num-5">5</text></svg>
                            </div>
                            <h2 class="font-bold text-slate-700">Refleksi Rekan Sejawat</h2>
                        </div>
                    </summary>
                    <div class="p-6 pt-0 border-t border-slate-50">
                        <div id="peer-review-list" class="space-y-2"></div>
                        <div id="btn-sec-5-final" class="mt-8 pt-4 border-t hidden">
                             <button type="button" onclick="window.validateAndNext(5)" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-sm">Lanjut</button>
                        </div>
                    </div>
                </details>

                <details id="sec-6" class="card shadow-sm card-disabled">
                    <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-slate-50 transition-colors list-none">
                        <div class="flex items-center space-x-4">
                            <div id="badge-6" class="status-badge status-incomplete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="icon-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" class="hidden" /><text x="7" y="17" font-size="14" font-weight="bold" fill="currentColor" id="num-6">6</text></svg>
                            </div>
                            <h2 class="font-bold text-slate-700">Komitmen & Konsekuensi Saya</h2>
                        </div>
                    </summary>
                    <div class="p-6 pt-0 border-t border-slate-50 space-y-6">
                        <textarea id="final_commitment" class="input-field comp-input" data-min="100" rows="4" required></textarea>
                        <textarea id="final_consequence" class="input-field border-red-200 bg-white comp-input" data-min="70" rows="4" placeholder="Konsekuensi..." required></textarea>
                        <div class="pt-6">
                            <button type="submit" id="btn-submit-all" class="w-full bg-slate-900 text-white font-bold py-5 rounded-xl shadow-xl hover:bg-black transition-all text-lg tracking-wide uppercase">Simpan Hasil Refleksi</button>
                        </div>
                    </div>
                </details>
            </form>
        </section>

        <!-- DASHBOARD (ANALISIS KOLEKTIF) -->
        <section id="content-dashboard" class="hidden space-y-12 pb-32">
            <!-- Summary Card -->
            <div class="card p-10 bg-gradient-to-br from-blue-700 to-indigo-900 text-white shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-32 w-32" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                </div>
                <h4 class="text-base font-bold opacity-80 uppercase tracking-widest mb-2">Partisipasi Kolektif SDN Perdana</h4>
                <div class="flex items-center space-x-6">
                    <span id="stat-count" class="text-8xl font-black">0</span>
                    <div class="text-xl font-semibold opacity-90 leading-tight">Pegawai telah memberikan<br>kontribusi refleksi mereka.</div>
                </div>
            </div>

            <!-- Analysis Container -->
            <div id="collective-analysis-container" class="space-y-12">
                <!-- JS Populated -->
            </div>
        </section>

        <!-- DATABASE (ADMIN ONLY) -->
        <section id="content-database" class="hidden space-y-6">
            <!-- API KEY SETTINGS -->
            <div class="card p-6 bg-slate-900 text-white shadow-lg border-none">
                <h4 class="text-xs font-black uppercase tracking-widest text-slate-400 mb-4">Pengaturan Analis AI</h4>
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Gemini API KEY</label>
                        <input type="password" id="gemini-api-key" class="w-full bg-slate-800 border-slate-700 text-white rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan Kunci API untuk mengaktifkan Tombol Generate AI">
                    </div>
                    <div class="flex items-end">
                        <button onclick="saveAPIKey()" class="bg-blue-600 px-6 py-2 rounded-lg font-bold text-sm hover:bg-blue-500 transition-all">Simpan Konfigurasi</button>
                    </div>
                </div>
                <p class="text-[9px] text-slate-500 mt-2">Dapatkan kunci API secara gratis di <a href="https://aistudio.google.com/" target="_blank" class="text-blue-400 underline">Google AI Studio</a>.</p>
            </div>

            <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border">
                <div class="flex space-x-2">
                    <button onclick="window.exportToExcel()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-xs font-bold uppercase hover:bg-emerald-700 shadow-md">Ekspor XLSX</button>
                    <button onclick="window.exportToPDF()" class="px-4 py-2 bg-rose-600 text-white rounded-lg text-xs font-bold uppercase hover:bg-rose-700 shadow-md">Ekspor PDF</button>
                </div>
                <div class="flex space-x-2">
                    <button onclick="window.backupJSON()" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-[10px] font-bold hover:bg-blue-200">Backup JSON</button>
                    <input type="file" id="restore-input" class="hidden" onchange="window.restoreJSON(event)">
                    <button onclick="document.getElementById('restore-input').click()" class="px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-[10px] hover:bg-slate-200">Restore</button>
                    <button onclick="window.clearAll()" class="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-[10px] font-bold hover:bg-red-200">Hapus Cloud</button>
                </div>
            </div>

            <div class="card shadow-sm border bg-white overflow-hidden">
                <div class="db-table-container">
                    <table id="db-raw-table" class="w-full text-left text-[10px]">
                        <thead class="bg-slate-50 uppercase tracking-tighter">
                            <tr>
                                <th class="p-3 border-b">No</th>
                                <th class="p-3 border-b">Timestamp</th>
                                <th class="p-3 border-b">Responden</th>
                                <th class="p-3 border-b">Mimpi Sekolah</th>
                                <th class="p-3 border-b">Kondisi Baik</th>
                                <th class="p-3 border-b">Indikator Baik</th>
                                <th class="p-3 border-b">Penyebab Baik</th>
                                <th class="p-3 border-b">Kondisi Buruk</th>
                                <th class="p-3 border-b">Indikator Buruk</th>
                                <th class="p-3 border-b">Penyebab Buruk</th>
                                <th class="p-3 border-b">Kelebihan Diri</th>
                                <th class="p-3 border-b">Kelemahan Diri</th>
                                <th class="p-3 border-b">Upaya Personal</th>
                                <th class="p-3 border-b">Komitmen</th>
                                <th class="p-3 border-b">Konsekuensi</th>
                            </tr>
                        </thead>
                        <tbody id="db-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Firebase & Analysis Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyC6IXCk6EXm0ndord8Is6cRZf_mG2MY5UM",
            authDomain: "kedinasan-d9051.firebaseapp.com",
            projectId: "kedinasan-d9051",
            storageBucket: "kedinasan-d9051.firebasestorage.app",
            messagingSenderId: "488517479224",
            appId: "1:488517479224:web:57ed244cf69e2a010c6fcd"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sdn-perdana-app';
        
        let apiKey = localStorage.getItem('sdn_gemini_api_key') || "";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const employees = [
            { name: "Neneng Imas Kurnia", prefix: "Ibu" }, { name: "Ujang Edi Brata", prefix: "Bapak" },
            { name: "Asep Ruhbi", prefix: "Bapak" }, { name: "Uju Juaenah", prefix: "Ibu" },
            { name: "Bahtiar Arifin", prefix: "Bapak" }, { name: "Cupang Sulastri", prefix: "Ibu" },
            { name: "Kamjah", prefix: "Bapak" }, { name: "Iis Isnayah", prefix: "Ibu" },
            { name: "Rini Lestari", prefix: "Ibu" }, { name: "Novianti", prefix: "Ibu" },
            { name: "Ahmad Sanusi", prefix: "Bapak" }, { name: "Samsudin", prefix: "Bapak" }
        ];

        let database = [];
        let isAdmin = localStorage.getItem('admin_sdn_active') === 'true';
        const reflectionsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'reflections');

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else { await signInAnonymously(auth); }
            } catch (error) { console.error("Auth error:", error); }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                onSnapshot(reflectionsCollection, (snapshot) => {
                    database = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderDashboard();
                    if (!document.getElementById('content-database').classList.contains('hidden')) renderDatabase();
                }, (error) => { console.error("Firestore sync error:", error); });
            }
        });

        window.onload = async () => {
            await initAuth();
            if (isAdmin) applyAdminState();
            if (apiKey) document.getElementById('gemini-api-key').value = apiKey;
            resetPrefixedInputs();
            renderDashboard();
        };

        window.saveAPIKey = () => {
            const val = document.getElementById('gemini-api-key').value.trim();
            if (val) {
                apiKey = val;
                localStorage.setItem('sdn_gemini_api_key', val);
                showMessage("Kunci API berhasil disimpan. Tombol Generate AI kini aktif.");
            }
        };

        function resetPrefixedInputs() {
            const fc = document.getElementById('final_commitment');
            if (fc) fc.value = "Saya berjanji ";
        }

        window.openLoginModal = () => document.getElementById('login-modal').classList.remove('hidden');
        window.closeLoginModal = () => document.getElementById('login-modal').classList.add('hidden');
        window.togglePasswordVisibility = () => {
            const pwd = document.getElementById('admin-password');
            pwd.type = pwd.type === "password" ? "text" : "password";
        };

        window.processLogin = () => {
            if (document.getElementById('admin-password').value === "EdiBrata#1") {
                isAdmin = true;
                if (document.getElementById('remember-me').checked) localStorage.setItem('admin_sdn_active', 'true');
                applyAdminState();
                window.closeLoginModal();
            } else { showMessage("Password Salah."); }
        };

        function applyAdminState() {
            document.getElementById('tab-database').classList.remove('hidden');
            document.getElementById('btn-login-admin').classList.add('hidden');
            document.getElementById('btn-logout-admin').classList.remove('hidden');
            for (let i = 1; i <= 6; i++) {
                const sec = document.getElementById(`sec-${i}`);
                if (sec) sec.classList.remove('card-disabled');
            }
            document.getElementById('sub-3b').classList.remove('sub-disabled');
            document.getElementById('btn-sec-3-final').classList.remove('hidden');
            document.getElementById('btn-sec-5-final').classList.remove('hidden');
        }

        window.logoutAdmin = () => { localStorage.removeItem('admin_sdn_active'); location.reload(); };

        // Gemini AI Implementation
        async function fetchAIAnalysis(data, sectionName) {
            if (!apiKey) return "API KEY Belum dikonfigurasi. Harap login admin dan masukkan Gemini API KEY di tab Database.";

            const systemPrompt = "Anda adalah konsultan pendidikan profesional. Tugas Anda adalah memberikan analisis deskriptif yang mendalam dan solutif terhadap data refleksi SDN Perdana. Gunakan bahasa Indonesia yang formal, berwibawa, dan memotivasi.";
            const userQuery = `Analisislah data kolektif untuk bagian "${sectionName}" berikut:\n\n${JSON.stringify(data)}\n\nTugas:\n1. Jelaskan pola atau aspirasi umum.\n2. Berikan kesimpulan mendalam.\n3. Berikan saran tindak lanjut strategis.\nSajikan jawaban dalam paragraf yang rapi dan font normal (bukan miring).`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, AI gagal menyusun narasi.";
                    }
                } catch (e) {}
                await new Promise(r => setTimeout(r, delay));
                delay *= 2;
            }
            return "Koneksi ke layanan AI terputus. Pastikan Kunci API valid.";
        }

        window.triggerAI = async (id, sectionKey, sectionName) => {
            const display = document.getElementById(`ai-box-${id}`);
            display.innerHTML = `
                <div class="p-8 flex items-center justify-center space-x-4 text-blue-600 bg-white rounded-2xl border-2 border-blue-100 shadow-sm">
                    <svg class="animate-spin h-8 w-8" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="text-xl font-bold">AI sedang menyusun analisis deskriptif untuk SDN Perdana...</span>
                </div>`;
            
            let rawData = id.startsWith('360') ? sectionKey : database.map(d => {
                if (typeof sectionKey === 'string') return d[sectionKey];
                return sectionKey.map(k => k.split('.').reduce((o, i) => o[i], d)).join(" | ");
            });

            const analysis = await fetchAIAnalysis(rawData, sectionName);
            display.innerHTML = `
                <div class="p-10 bg-gradient-to-br from-white to-blue-50 rounded-2xl border-2 border-blue-200 shadow-xl presentation-text">
                    <div class="font-black text-blue-800 mb-6 flex items-center presentation-title uppercase tracking-tighter">
                        <svg class="h-8 w-8 mr-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zM7 10a1 1 0 01-1 1H5a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM9 11l.012 2.012c.03.762.534 1.456 1.251 1.737L13 16l-2.737.749a2.001 2.001 0 00-1.251 1.737L9 20.5l-.012-2.012a2.001 2.001 0 00-1.251-1.737L5 16l2.737-.749a2.001 2.001 0 001.251-1.737L9 11z"/></svg>
                        Hasil Analisis Strategis AI (Deskriptif)
                    </div>
                    <div class="whitespace-pre-wrap">${analysis}</div>
                </div>`;
        };

        window.renderDashboard = () => {
            document.getElementById('stat-count').textContent = database.length;
            const container = document.getElementById('collective-analysis-container');
            if (!container) return;
            container.innerHTML = "";
            if (database.length === 0) return;

            const sections = [
                { id: "vision", title: "Mimpi & Harapan Kolektif", key: "vision" },
                { id: "cond", title: "Potret Kondisi Sekolah (Lengkap)", keys: ["condition.good", "condition.good_ind", "condition.good_cause", "condition.bad", "condition.bad_ind", "condition.bad_cause"] },
                { id: "personal", title: "Refleksi Kinerja Individu Kolektif", keys: ["self.strength", "self.weakness", "self.effort"] },
                { id: "comm", title: "Komitmen & Konsekuensi Kolektif", keys: ["commitment", "consequence"] }
            ];

            sections.forEach(s => {
                const acc = document.createElement('details');
                acc.className = "card border shadow-lg group";
                acc.innerHTML = `
                    <summary class="flex items-center justify-between p-8 cursor-pointer bg-white group-open:bg-slate-50 transition-all border-l-8 border-blue-700">
                        <div class="flex items-center space-x-6">
                            <div class="w-14 h-14 rounded-2xl bg-blue-100 flex items-center justify-center text-blue-700 shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                            </div>
                            <h3 class="presentation-title uppercase tracking-tight">${s.title}</h3>
                        </div>
                        <svg class="h-8 w-8 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <div class="p-10 pt-4 border-t space-y-8 bg-slate-50/20">
                        <div class="space-y-6">
                            ${database.map((entry, idx) => `
                                <div class="p-8 bg-white border-2 border-slate-100 rounded-3xl shadow-sm presentation-text">
                                    <div class="flex items-center space-x-2 mb-6">
                                        <span class="px-4 py-1.5 bg-slate-900 rounded-full text-xs font-black text-white uppercase tracking-widest">Responden #${idx + 1}</span>
                                    </div>
                                    <div class="space-y-6">
                                        ${s.key ? `<div class="text-slate-800 leading-relaxed font-medium">"${entry[s.key]}"</div>` : s.keys.map(k => {
                                            const v = k.split('.').reduce((o, i) => o[i], entry);
                                            const label = k.split('.').pop().replace('_', ' ').toUpperCase();
                                            return `<div class="p-6 bg-slate-50 rounded-2xl border border-slate-100 shadow-inner"><span class="presentation-label block mb-3">${label}</span><div class="text-slate-800 leading-relaxed font-medium">"${v}"</div></div>`;
                                        }).join("")}
                                    </div>
                                </div>
                            `).join("")}
                        </div>
                        <div id="ai-box-${s.id}" class="mt-16 pt-12 border-t-4 border-blue-100 border-dotted">
                            <button onclick="window.triggerAI('${s.id}', ${JSON.stringify(s.key || s.keys)}, '${s.title}')" class="w-full flex items-center justify-center px-8 py-6 bg-blue-700 text-white rounded-3xl text-xl font-black hover:bg-blue-800 shadow-2xl shadow-blue-200 ai-glow transition-all uppercase tracking-widest">
                                <svg class="h-8 w-8 mr-4" fill="currentColor" viewBox="0 0 20 20"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707 7z" /></svg>
                                Analisis Deskriptif Strategis AI
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(acc);
            });

            // Refleksi 360 Presentation
            const peerHeading = document.createElement('div');
            peerHeading.className = "pt-20 pb-8 border-t-2 mt-20";
            peerHeading.innerHTML = `<h3 class="text-5xl font-black text-slate-900 uppercase tracking-tighter">Analisis Refleksi 360°</h3>
            <p class="text-xl text-slate-400 font-bold uppercase tracking-widest mt-4">Kumpulan umpan balik objektif kolektif per pegawai</p>`;
            container.appendChild(peerHeading);
            
            employees.forEach(emp => {
                const reviews = database.map(d => d.peerReviews?.[emp.name]).filter(r => r && r.strength);
                if (reviews.length > 0) {
                    const id = emp.name.replace(/\s+/g, '_');
                    const acc360 = document.createElement('details');
                    acc360.className = "card border shadow-xl mb-8 group";
                    acc360.innerHTML = `
                        <summary class="flex items-center justify-between p-8 cursor-pointer bg-white group-open:bg-emerald-50 transition-all border-l-8 border-emerald-600">
                            <div class="flex items-center space-x-6">
                                <div class="w-16 h-16 rounded-2xl bg-emerald-600 flex items-center justify-center text-white font-black text-2xl shadow-xl shadow-emerald-100">${emp.name.split(' ').map(n=>n[0]).join('')}</div>
                                <div>
                                    <div class="text-2xl font-black text-slate-800">${emp.name}</div>
                                    <div class="text-sm font-bold text-emerald-600 uppercase tracking-widest mt-1">${reviews.length} Rekan Sejawat Telah Memberi Masukan</div>
                                </div>
                            </div>
                            <svg class="h-10 w-10 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </summary>
                        <div class="p-10 pt-8 border-t space-y-12 bg-white">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
                                <div class="space-y-6">
                                    <h5 class="presentation-label bg-emerald-100 px-6 py-2 rounded-2xl inline-block shadow-sm">Kelebihan</h5>
                                    <div class="space-y-4 presentation-text leading-relaxed font-medium">${reviews.map(r => `<div class="p-6 bg-emerald-50/40 rounded-3xl border-l-4 border-emerald-500 shadow-sm leading-relaxed text-slate-800">"${r.strength}"</div>`).join("")}</div>
                                </div>
                                <div class="space-y-6">
                                    <h5 class="presentation-label bg-rose-100 text-rose-700 px-6 py-2 rounded-2xl inline-block shadow-sm">Kelemahan</h5>
                                    <div class="space-y-4 presentation-text leading-relaxed font-medium">${reviews.map(r => `<div class="p-6 bg-rose-50/40 rounded-3xl border-l-4 border-rose-500 shadow-sm leading-relaxed text-slate-800">"${r.weakness}"</div>`).join("")}</div>
                                </div>
                                <div class="space-y-6">
                                    <h5 class="presentation-label bg-blue-100 text-blue-700 px-6 py-2 rounded-2xl inline-block shadow-sm">Harapan</h5>
                                    <div class="space-y-4 presentation-text leading-relaxed font-medium">${reviews.map(r => `<div class="p-6 bg-blue-50/40 rounded-3xl border-l-4 border-blue-500 shadow-sm leading-relaxed text-slate-800">"${r.hope}"</div>`).join("")}</div>
                                </div>
                            </div>
                            <div id="ai-box-360-${id}" class="mt-16 pt-12 border-t-4 border-emerald-100 border-dotted">
                                <button onclick="window.triggerAI('360-${id}', ${JSON.stringify(reviews)}, 'Analisis Profil Profesional Untuk ${emp.name}')" class="w-full flex items-center justify-center px-8 py-6 bg-emerald-600 text-white rounded-3xl text-xl font-black hover:bg-emerald-700 shadow-2xl shadow-emerald-200 ai-glow transition-all uppercase tracking-widest">
                                    Simpulkan Profil Profesional ${emp.name.split(' ')[0]} via AI
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(acc360);
                }
            });
        };

        // Shared Functions
        window.showMessage = (msg) => {
            const div = document.createElement('div');
            div.className = "fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl z-[200] font-bold text-sm tracking-wide";
            div.textContent = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        };

        // UI Builder for Peer Review
        const peerList = document.getElementById('peer-review-list');
        employees.forEach((emp, index) => {
            const id = emp.name.replace(/\s+/g, '_');
            const details = document.createElement('details');
            details.id = `item-${id}`;
            details.className = `sub-accordion group ${index > 0 ? 'sub-disabled' : ''}`;
            details.innerHTML = `
                <summary class="flex items-center justify-between p-4 cursor-pointer list-none">
                    <div class="flex items-center space-x-3">
                        <div id="peer-status-${id}" class="w-2 h-2 rounded-full bg-slate-300"></div>
                        <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-[10px] font-bold text-blue-600">${emp.name.split(' ').map(n => n[0]).join('')}</div>
                        <span class="text-sm font-semibold text-slate-700">${emp.name}</span>
                    </div>
                </summary>
                <div class="p-4 pt-0 border-t space-y-4">
                    <div class="grid grid-cols-1 gap-4 mt-4">
                        <textarea name="strength_${id}" rows="2" data-min="60" placeholder="Kelebihan ${emp.name}..." class="comp-input input-field text-xs" required></textarea>
                        <textarea name="weakness_${id}" rows="2" data-min="60" placeholder="Kelemahan..." class="comp-input input-field text-xs" required></textarea>
                        <textarea name="hope_${id}" rows="2" data-min="60" placeholder="Harapan..." class="comp-input input-field text-xs" required></textarea>
                        <button type="button" onclick="window.validatePeer('${id}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold">Simpan Penilaian Rekan</button>
                    </div>
                </div>`;
            peerList.appendChild(details);
        });

        // Other Shared Logic (Submission, Navigation, Export) Tetap Sama
        window.validateAndNext = (n) => {
            const sec = document.getElementById(`sec-${n}`);
            if (!isAdmin) {
                const visibleInputs = Array.from(sec.querySelectorAll('.comp-input, select[required]')).filter(i => !i.closest('.hidden'));
                let valid = true;
                visibleInputs.forEach(i => { 
                    if (i.tagName === 'TEXTAREA' && i.value.trim().length < parseInt(i.dataset.min)) valid = false; 
                    else if (!i.value) valid = false; 
                });
                if (!valid) { showMessage("Data kurang lengkap atau isian belum komprehensif."); return; }
            }
            sec.removeAttribute('open');
            const badge = document.getElementById(`badge-${n}`);
            badge.classList.replace('status-incomplete', 'status-complete');
            const num = document.getElementById(`num-${n}`); if (num) num.classList.add('hidden');
            const icon = badge.querySelector('path'); if (icon) icon.classList.remove('hidden');
            const next = document.getElementById(`sec-${n + 1}`);
            if (next) { next.classList.remove('card-disabled'); next.setAttribute('open', ''); next.scrollIntoView({ behavior: 'smooth' }); }
        };

        window.validateSub = (sec, part) => {
            const sub = document.getElementById(`sub-${sec}${part}`);
            const tas = sub.querySelectorAll('.comp-input');
            let valid = true;
            tas.forEach(ta => { if (ta.value.trim().length < parseInt(ta.dataset.min)) valid = false; });
            if (valid || isAdmin) {
                sub.removeAttribute('open');
                if (part === 'a') { document.getElementById(`sub-${sec}b`).classList.remove('sub-disabled'); document.getElementById(`sub-${sec}b`).setAttribute('open', ''); }
                else { document.getElementById('btn-sec-3-final').classList.remove('hidden'); }
            } else { showMessage("Isian belum komprehensif."); }
        };

        window.validatePeer = (id) => {
            const tas = document.getElementById(`item-${id}`).querySelectorAll('.comp-input');
            let valid = true;
            tas.forEach(ta => { if (ta.value.trim().length < parseInt(ta.dataset.min)) valid = false; });
            if (valid || isAdmin) {
                document.getElementById(`peer-status-${id}`).classList.replace('bg-slate-300', 'bg-green-500');
                document.getElementById(`item-${id}`).removeAttribute('open');
                let next = document.getElementById(`item-${id}`).nextElementSibling;
                while (next && next.classList.contains('hidden')) next = next.nextElementSibling;
                if (next) { next.classList.remove('sub-disabled'); next.setAttribute('open', ''); }
                else { document.getElementById('btn-sec-5-final').classList.remove('hidden'); }
            } else { showMessage("Input penilaian belum lengkap."); }
        };

        window.filterPeerReview = () => {
            const user = document.getElementById('user_name').value;
            employees.forEach(emp => {
                const id = emp.name.replace(/\s+/g, '_');
                const el = document.getElementById(`item-${id}`);
                const isSelf = emp.name === user;
                el.classList.toggle('hidden', isSelf);
                el.querySelectorAll('textarea').forEach(ta => { ta.required = !isSelf; });
                if (!isAdmin && emp.name !== user && el.previousElementSibling?.classList.contains('hidden')) el.classList.remove('sub-disabled');
            });
        };

        window.switchTab = (tab) => {
            ['form', 'dashboard', 'database'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                const btn = document.getElementById(`tab-${t}`); if(btn) btn.classList.replace('tab-active', 'tab-inactive');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-${tab}`); if(activeBtn) activeBtn.classList.replace('tab-inactive', 'tab-active');
            if (tab === 'dashboard') renderDashboard();
            if (tab === 'database') renderDatabase();
        };

        document.getElementById('masterForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btnSubmit = document.getElementById('btn-submit-all');
            const originalText = btnSubmit.innerHTML;
            try {
                if (isAdmin) { showMessage("Mode Admin Aktif."); return; }
                if (!auth.currentUser) { showMessage("Cloud Belum Siap."); return; }
                btnSubmit.disabled = true; btnSubmit.innerHTML = "Menyimpan...";
                const current = document.getElementById('user_name').value;
                const peers = {};
                employees.forEach(emp => {
                    if (emp.name !== current) {
                        const id = emp.name.replace(/\s+/g, '_');
                        peers[emp.name] = {
                            strength: document.querySelector(`[name="strength_${id}"]`).value,
                            weakness: document.querySelector(`[name="weakness_${id}"]`).value,
                            hope: document.querySelector(`[name="hope_${id}"]`).value
                        };
                    }
                });
                const reflectionData = {
                    user: current, vision: document.getElementById('self_vision').value,
                    condition: { 
                        good: document.getElementById('cond_good').value, good_ind: document.getElementById('cond_good_indicator').value, good_cause: document.getElementById('cond_good_cause').value,
                        bad: document.getElementById('cond_bad').value, bad_ind: document.getElementById('cond_bad_indicator').value, bad_cause: document.getElementById('cond_bad_cause').value
                    },
                    self: { strength: document.getElementById('self_strength').value, weakness: document.getElementById('self_weakness').value, effort: document.getElementById('self_effort').value },
                    peerReviews: peers, commitment: document.getElementById('final_commitment').value, consequence: document.getElementById('final_consequence').value,
                    timestamp: new Date().toLocaleString(), createdAt: Date.now()
                };
                await addDoc(reflectionsCollection, reflectionData);
                showMessage("Berhasil disimpan!");
                location.reload();
            } catch (error) { showMessage(error.message); btnSubmit.disabled = false; btnSubmit.innerHTML = originalText; }
        });

        window.renderDatabase = () => {
            const tbody = document.getElementById('db-body'); if (!tbody) return;
            tbody.innerHTML = database.length ? '' : '<tr><td colspan="15" class="p-10 text-center italic text-slate-400 font-medium">Belum ada data refleksi masuk.</td></tr>';
            database.slice().reverse().forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="p-3 border-b">${database.length - idx}</td><td class="p-3 border-b">${row.timestamp}</td><td class="p-3 border-b font-bold">${row.user}</td><td class="p-3 border-b max-w-[150px] truncate">${row.vision}</td><td class="p-3 border-b max-w-[150px] truncate">${row.condition.good}</td><td class="p-3 border-b max-w-[150px] truncate">${row.condition.good_ind}</td><td class="p-3 border-b max-w-[150px] truncate">${row.condition.good_cause}</td><td class="p-3 border-b max-w-[150px] truncate">${row.condition.bad}</td><td class="p-3 border-b max-w-[150px] truncate">${row.condition.bad_ind}</td><td class="p-3 border-b max-w-[150px] truncate">${row.condition.bad_cause}</td><td class="p-3 border-b max-w-[150px] truncate">${row.self.strength}</td><td class="p-3 border-b max-w-[150px] truncate">${row.self.weakness}</td><td class="p-3 border-b max-w-[150px] truncate">${row.self.effort}</td><td class="p-3 border-b max-w-[150px] truncate">${row.commitment}</td><td class="p-3 border-b max-w-[150px] truncate">${row.consequence}</td>`;
                tbody.appendChild(tr);
            });
        };

        window.exportToExcel = () => {
            const ws = XLSX.utils.json_to_sheet(database.map((d, i) => ({ No: i + 1, Waktu: d.timestamp, Nama: d.user, Visi: d.vision, Baik: d.condition.good, Buruk: d.condition.bad, Komitmen: d.commitment })));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, "Rekap_Refleksi.xlsx");
        };

        window.exportToPDF = async () => {
            const { jsPDF } = window.jspdf; const docPdf = new jsPDF('l', 'pt', 'a4');
            docPdf.setFontSize(14); docPdf.text("Rekapitulasi Refleksi SDN Perdana", 40, 40);
            docPdf.autoTable({ head: [["No", "Waktu", "Nama", "Mimpi"]], body: database.map((d, i) => [i + 1, d.timestamp, d.user, d.vision.substring(0, 50)+'...']), startY: 60 });
            docPdf.save("Rekap_Refleksi.pdf");
        };

        window.backupJSON = () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(database, null, 2)], { type: 'application/json' })); a.download = `backup_${Date.now()}.json`; a.click(); };
        window.clearAll = async () => { if (confirm("Hapus seluruh database cloud?")) { await Promise.all(database.map(row => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reflections', row.id)))); location.reload(); } };
    </script>
</body>
</html>
