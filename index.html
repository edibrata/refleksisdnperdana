<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Refleksi Komprehensif SDN Perdana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Pustaka Ekspor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        
        details summary::-webkit-details-marker { display:none; }
        details summary { list-style: none; }
        
        .card { background: white; border-radius: 1rem; border: 1px solid #e2e8f0; overflow: hidden; transition: all 0.3s ease; }
        .card-disabled { opacity: 0.6; pointer-events: none; background-color: #f1f5f9; }
        
        .input-field { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.6rem; outline: none; transition: all 0.2s; font-size: 0.875rem; resize: vertical; }
        .input-field:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        
        .char-hint { font-size: 0.7rem; color: #94a3b8; margin-top: 0.25rem; font-weight: 600; display: flex; justify-content: space-between; }
        .char-error { color: #ef4444 !important; }
        .char-success { color: #22c55e !important; }
        
        .tab-active { border-bottom: 3px solid #1e40af; color: #1e40af; font-weight: 700; }
        .tab-inactive { color: #64748b; }
        
        .sub-accordion { border: 1px solid #f1f5f9; border-radius: 0.75rem; margin-bottom: 0.5rem; transition: all 0.2s; }
        .sub-accordion[open] { border-color: #dbeafe; background-color: #fcfdfe; }
        .sub-disabled { opacity: 0.5; pointer-events: none; }
        
        .status-badge { display: flex; items-center: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; transition: all 0.3s; }
        .status-incomplete { background-color: #e2e8f0; color: #94a3b8; }
        .status-complete { background-color: #22c55e; color: white; }

        .hidden { display: none; }
        #login-modal { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); }
        .db-table-container { max-height: 700px; overflow: auto; }
        table thead th { position: sticky; top: 0; background: #f8fafc; z-index: 10; border-bottom: 2px solid #e2e8f0; }

        .ai-glow { animation: glow 2s infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px #3b82f6; } to { box-shadow: 0 0 20px #3b82f6; } }
    </style>
</head>
<body class="text-slate-800">

    <nav class="bg-white border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center space-x-2">
                    <div class="bg-blue-700 p-2 rounded-lg text-white shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <span class="font-bold text-lg tracking-tight">Refleksi Kinerja SDN Perdana</span>
                </div>
                <div class="flex items-center space-x-6 text-sm">
                    <button onclick="switchTab('form')" id="tab-form" class="tab-active py-5 transition-all">Formulir</button>
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-inactive py-5 transition-all">Analisis Kolektif</button>
                    <button onclick="switchTab('database')" id="tab-database" class="tab-inactive py-5 transition-all hidden">Database</button>
                    <button onclick="openLoginModal()" id="btn-login-admin" class="ml-4 px-3 py-1 bg-slate-100 text-slate-500 rounded-md hover:bg-slate-200 transition-colors text-xs font-bold uppercase tracking-wide">Login Admin</button>
                    <button onclick="logoutAdmin()" id="btn-logout-admin" class="ml-4 px-3 py-1 bg-red-50 text-red-600 rounded-md hover:bg-red-100 transition-colors text-xs font-bold uppercase hidden tracking-wide">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden p-8">
            <h3 class="text-xl font-bold text-slate-800 mb-6">Akses Administrator</h3>
            <div class="space-y-4">
                <div class="relative">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Password</label>
                    <input type="password" id="admin-password" class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none focus:border-blue-500" placeholder="••••••••">
                    <button onclick="togglePasswordVisibility()" class="absolute right-3 top-7 text-slate-400 hover:text-slate-600">
                        <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    </button>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="remember-me" class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                    <label for="remember-me" class="text-sm text-slate-600">Ingat Saya</label>
                </div>
                <div class="flex space-x-3 pt-2">
                    <button onclick="closeLoginModal()" class="flex-1 px-4 py-2 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-all">Batal</button>
                    <button onclick="processLogin()" class="flex-1 bg-blue-700 text-white px-4 py-2 rounded-xl font-bold hover:bg-blue-800 transition-all shadow-lg shadow-blue-100">Login</button>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-5xl mx-auto px-4 py-8">

        <!-- SECTION: FORMULIR -->
        <section id="content-form">
            <form id="masterForm" class="space-y-6 pb-20">
                
                <!-- BLOK 1: IDENTITAS -->
                <details id="sec-1" class="card shadow-sm" open>
                    <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-slate-50 transition-colors list-none">
                        <div class="flex items-center space-x-4">
                            <div id="badge-1" class="status-badge status-incomplete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="icon-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" class="hidden" /><text x="7" y="17" font-size="14" font-weight="bold" fill="currentColor" id="num-1">1</text></svg>
                            </div>
                            <h2 class="font-bold text-slate-700">Identitas Pegawai</h2>
                        </div>
                    </summary>
                    <div class="p-6 pt-0 border-t border-slate-50">
                        <div class="max-w-md space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">Pilih Nama Anda</label>
                                <select id="user_name" class="input-field" required onchange="window.filterPeerReview()">
                                    <option value="">-- Pilih Nama --</option>
                                    <option>Neneng Imas Kurnia</option>
                                    <option>Ujang Edi Brata</option>
                                    <option>Asep Ruhbi</option>
                                    <option>Uju Juaenah</option>
                                    <option>Bahtiar Arifin</option>
                                    <option>Cupang Sulastri</option>
                                    <option>Kamjah</option>
                                    <option>Iis Isnayah</option>
                                    <option>Rini Lestari</option>
                                    <option>Novianti</option>
                                    <option>Ahmad Sanusi</option>
                                    <option>Samsudin</option>
                                </select>
                            </div>
                            <button type="button" onclick="window.validateAndNext(1)" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 transition-colors shadow-sm">Lanjut</button>
                        </div>
                    </div>
                </details>

                <!-- BLOK 2: MIMPI & HARAPAN -->
                <details id="sec-2" class="card shadow-sm card-disabled">
                    <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-slate-50 transition-colors list-none">
                        <div class="flex items-center space-x-4">
                            <div id="badge-2" class="status-badge status-incomplete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="icon-2"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" class="hidden" /><text x="7" y="17" font-size="14" font-weight="bold" fill="currentColor" id="num-2">2</text></svg>
                            </div>
                            <h2 class="font-bold text-slate-700">Mimpi & Harapan Saya terhadap Sekolah</h2>
                        </div>
                    </summary>
                    <div class="p-6 pt-0 border-t border-slate-50 space-y-4">
                        <label class="block text-sm text-slate-600 mb-3 leading-relaxed font-medium">
                            Tuangkan pandangan jujur Anda mengenai sekolah impian. Menurut Anda, SDN Perdana ini idealnya harus berkembang ke arah mana dan menjadi sekolah yang seperti apa di masa depan?
                        </label>
                        <div class="relative">
                            <textarea id="self_vision" class="input-field comp-input" rows="6" data-min="150" placeholder="Ceritakan cita-cita atau gambaran sekolah ideal menurut versi Anda..." required></textarea>
                            <div class="char-hint"><span>Wajib diisi secara komprehensif (Minimal 150 Karakter)</span><span class="char-count text-slate-400">0 / 150</span></div>
                        </div>
                        <button type="button" onclick="window.validateAndNext(2)" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 transition-colors shadow-sm">Lanjut</button>
                    </div>
                </details>

                <!-- BLOK 3: KONDISI SEKOLAH -->
                <details id="sec-3" class="card shadow-sm card-disabled border-l-4 border-l-amber-400">
                    <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-slate-50 transition-colors list-none">
                        <div class="flex items-center space-x-4">
                            <div id="badge-3" class="status-badge status-incomplete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="icon-3"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" class="hidden" /><text x="7" y="17" font-size="14" font-weight="bold" fill="currentColor" id="num-3">3</text></svg>
                            </div>
                            <h2 class="font-bold text-slate-700">Kondisi Sekolah Saat Ini Menurut Saya</h2>
                        </div>
                    </summary>
                    <div class="p-6 pt-0 border-t border-slate-50 space-y-4">
                        <details id="sub-3a" class="sub-accordion group" open>
                            <summary class="flex items-center justify-between p-4 cursor-pointer list-none bg-emerald-50/50 rounded-t-lg">
                                <span class="text-sm font-bold text-emerald-700 uppercase tracking-wide">Aspek Positif (Kondisi Baik)</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-emerald-500 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </summary>
                            <div class="p-4 space-y-4 bg-white border-x border-b rounded-b-lg border-emerald-100">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Kondisi Baik</label>
                                    <textarea id="cond_good" class="input-field comp-input" data-min="80" rows="3" placeholder="Sebutkan hal-hal yang menurut Anda sudah berjalan dengan baik..." required></textarea>
                                    <div class="char-hint"><span>Minimal 80 Karakter</span><span class="char-count">0 / 80</span></div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Indikator Kondisi Baik</label>
                                    <textarea id="cond_good_indicator" class="input-field comp-input" data-min="80" rows="3" placeholder="Apa bukti atau tanda bahwa hal tersebut sudah baik?..." required></textarea>
                                    <div class="char-hint"><span>Minimal 80 Karakter</span><span class="char-count">0 / 80</span></div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Penyebab Kondisi Baik</label>
                                    <textarea id="cond_good_cause" class="input-field comp-input" data-min="80" rows="3" placeholder="Mengapa hal tersebut bisa menjadi baik?..." required></textarea>
                                    <div class="char-hint"><span>Minimal 80 Karakter</span><span class="char-count">0 / 80</span></div>
                                </div>
                                <div class="pt-2">
                                    <button type="button" onclick="window.validateSub(3, 'a')" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-emerald-700 transition-all shadow-md">Lanjut ke Aspek Memprihatinkan</button>
                                </div>
                            </div>
                        </details>

                        <details id="sub-3b" class="sub-accordion group sub-disabled">
                            <summary class="flex items-center justify-between p-4 cursor-pointer list-none bg-rose-50/50 rounded-t-lg">
                                <span class="text-sm font-bold text-rose-700 uppercase tracking-wide">Aspek Memprihatinkan (Tidak Baik)</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-rose-500 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </summary>
                            <div class="p-4 space-y-4 bg-white border-x border-b rounded-b-lg border-rose-100">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Kondisi Memprihatinkan / Tidak Baik</label>
                                    <textarea id="cond_bad" class="input-field comp-input" data-min="80" rows="3" placeholder="Sebutkan hal-hal yang menurut Anda masih buruk..." required></textarea>
                                    <div class="char-hint"><span>Minimal 80 Karakter</span><span class="char-count">0 / 80</span></div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Indikator Kondisi Memprihatinkan</label>
                                    <textarea id="cond_bad_indicator" class="input-field comp-input" data-min="80" rows="3" placeholder="Apa bukti nyata?..." required></textarea>
                                    <div class="char-hint"><span>Minimal 80 Karakter</span><span class="char-count">0 / 80</span></div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Penyebab Kondisi Memprihatinkan</label>
                                    <textarea id="cond_bad_cause" class="input-field comp-input" data-min="80" rows="3" placeholder="Apa faktor utamanya?..." required></textarea>
                                    <div class="char-hint"><span>Minimal 80 Karakter</span><span class="char-count">0 / 80</span></div>
                                </div>
                                <div class="pt-2">
                                    <button type="button" onclick="window.validateSub(3, 'b')" class="bg-rose-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-rose-700 transition-all shadow-md">Selesai Evaluasi Kondisi</button>
                                </div>
                            </div>
                        </details>
                        <div id="btn-sec-3-final" class="hidden pt-2"><button type="button" onclick="window.validateAndNext(3)" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 shadow-sm">Lanjut</button></div>
                    </div>
                </details>

                <!-- BLOK 4: REFLEKSI KINERJA -->
                <details id="sec-4" class="card shadow-sm card-disabled">
                    <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-slate-50 transition-colors list-none">
                        <div class="flex items-center space-x-4">
                            <div id="badge-4" class="status-badge status-incomplete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="icon-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" class="hidden" /><text x="7" y="17" font-size="14" font-weight="bold" fill="currentColor" id="num-4">4</text></svg>
                            </div>
                            <h2 class="font-bold text-slate-700">Refleksi Kinerja Saya</h2>
                        </div>
                    </summary>
                    <div class="p-6 pt-0 border-t border-slate-50 space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Apa kekuatan dan kontribusi terbaik saya bagi sekolah selama ini? Apa yang sudah saya berikan secara maksimal?</label>
                            <textarea id="self_strength" class="input-field comp-input" data-min="100" rows="4" placeholder="Sampaikan pencapaian positif Anda..." required></textarea>
                            <div class="char-hint"><span>Minimal 100 Karakter</span><span class="char-count">0 / 100</span></div>
                        </div>
                        <div class="pt-4 border-t border-slate-100">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Secara jujur, kekurangan, kendala, atau kesalahan yang saya alami dalam bekerja adalah ...</label>
                            <textarea id="self_weakness" class="input-field comp-input" data-min="100" rows="4" placeholder="Hal yang menghambat kinerja..." required></textarea>
                            <div class="char-hint"><span>Minimal 100 Karakter</span><span class="char-count">0 / 100</span></div>
                        </div>
                        <div class="pt-4 border-t border-slate-100">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Upaya apa yang akan saya lakukan untuk mengatasi hambatan tersebut?</label>
                            <textarea id="self_effort" class="input-field comp-input" data-min="100" rows="4" placeholder="Langkah perbaikan nyata..." required></textarea>
                            <div class="char-hint"><span>Minimal 100 Karakter</span><span class="char-count">0 / 100</span></div>
                        </div>
                        <button type="button" onclick="window.validateAndNext(4)" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 shadow-sm">Lanjut</button>
                    </div>
                </details>

                <!-- BLOK 5: REFLEKSI 360 -->
                <details id="sec-5" class="card shadow-sm card-disabled">
                    <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-slate-50 transition-colors list-none">
                        <div class="flex items-center space-x-4">
                            <div id="badge-5" class="status-badge status-incomplete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="icon-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" class="hidden" /><text x="7" y="17" font-size="14" font-weight="bold" fill="currentColor" id="num-5">5</text></svg>
                            </div>
                            <h2 class="font-bold text-slate-700">Refleksi Rekan Sejawat (360°)</h2>
                        </div>
                    </summary>
                    <div class="p-6 pt-0 border-t border-slate-50">
                        <p class="text-[11px] text-slate-500 mb-6 italic leading-relaxed font-medium">
                            Semua rekan wajib dinilai secara berurutan dengan jawaban komprehensif.
                        </p>
                        <div id="peer-review-list" class="space-y-2">
                            <!-- JS Generated -->
                        </div>
                        <div id="btn-sec-5-final" class="mt-8 pt-4 border-t hidden">
                             <button type="button" onclick="window.validateAndNext(5)" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 shadow-sm">Lanjut ke Bagian Akhir</button>
                        </div>
                    </div>
                </details>

                <!-- BLOK 6: KOMITMEN -->
                <details id="sec-6" class="card shadow-sm card-disabled">
                    <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-slate-50 transition-colors list-none">
                        <div class="flex items-center space-x-4">
                            <div id="badge-6" class="status-badge status-incomplete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="icon-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" class="hidden" /><text x="7" y="17" font-size="14" font-weight="bold" fill="currentColor" id="num-6">6</text></svg>
                            </div>
                            <h2 class="font-bold text-slate-700">Komitmen & Konsekuensi Saya</h2>
                        </div>
                    </summary>
                    <div class="p-6 pt-0 border-t border-slate-50 space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">Komitmen Saya</label>
                            <textarea id="final_commitment" class="input-field comp-input" data-min="100" rows="4" required placeholder="Saya berjanji..."></textarea>
                            <div class="char-hint"><span>Minimal 100 Karakter</span><span class="char-count">0 / 100</span></div>
                        </div>
                        <div class="bg-red-50 p-6 rounded-xl border border-red-100 shadow-inner">
                            <label class="block text-xs font-bold text-red-900 mb-2 tracking-wider uppercase">Pernyataan Konsekuensi Saya</label>
                            <p class="text-xs text-red-700 mb-3 italic">
                                "Apabila saya tidak memenuhi komitmen kerja tersebut di atas, maka saya secara sadar bersedia menerima konsekuensi berupa:"
                            </p>
                            <textarea id="final_consequence" class="input-field border-red-200 bg-white comp-input" data-min="70" rows="4" placeholder="Sebutkan konsekuensi tegas..." required></textarea>
                            <div class="char-hint"><span class="text-red-600">Min 70 Karakter</span><span class="char-count">0 / 70</span></div>
                        </div>
                        <div class="pt-6">
                            <button type="submit" id="btn-submit-all" class="w-full bg-slate-900 text-white font-bold py-5 rounded-xl shadow-xl hover:bg-black transition-all text-lg tracking-wide uppercase flex items-center justify-center space-x-2">
                                <span>Simpan Seluruh Hasil Refleksi</span>
                            </button>
                        </div>
                    </div>
                </details>
            </form>
        </section>

        <!-- DASHBOARD (ANALISIS KOLEKTIF) -->
        <section id="content-dashboard" class="hidden space-y-10 pb-20">
            <!-- Summary Card -->
            <div class="card p-8 bg-gradient-to-br from-blue-700 to-indigo-900 text-white shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-32 w-32" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                </div>
                <h4 class="text-sm font-bold opacity-80 uppercase tracking-widest mb-1">Status Partisipasi</h4>
                <div class="flex items-center space-x-4">
                    <span id="stat-count" class="text-6xl font-black">0</span>
                    <div class="text-sm font-medium opacity-90 leading-tight">Pegawai telah memberikan<br>hasil refleksi mereka secara anonim.</div>
                </div>
            </div>

            <!-- Analysis Container -->
            <div id="collective-analysis-container" class="space-y-8">
                <!-- JS Populated -->
            </div>
        </section>

        <!-- DATABASE (ADMIN ONLY) -->
        <section id="content-database" class="hidden space-y-4">
            <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border">
                <div class="flex space-x-2">
                    <button onclick="window.exportToExcel()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-xs font-bold uppercase hover:bg-emerald-700 shadow-md transition-all">Ekspor XLSX</button>
                    <button onclick="window.exportToPDF()" class="px-4 py-2 bg-rose-600 text-white rounded-lg text-xs font-bold uppercase hover:bg-rose-700 shadow-md transition-all">Ekspor PDF</button>
                </div>
                <div class="flex space-x-2">
                    <button onclick="window.backupJSON()" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-[10px] font-bold uppercase hover:bg-blue-200">Backup JSON</button>
                    <input type="file" id="restore-input" class="hidden" onchange="window.restoreJSON(event)">
                    <button onclick="document.getElementById('restore-input').click()" class="px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-[10px] font-bold uppercase hover:bg-slate-200">Restore</button>
                    <button onclick="window.clearAll()" class="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-[10px] font-bold uppercase hover:bg-red-200">Hapus Database</button>
                </div>
            </div>

            <div class="card shadow-sm border bg-white overflow-hidden">
                <div class="db-table-container">
                    <table id="db-raw-table" class="w-full text-left text-[10px]">
                        <thead class="bg-slate-50 uppercase tracking-tighter">
                            <tr>
                                <th class="p-3 border-b border-slate-200">No</th>
                                <th class="p-3 border-b border-slate-200">Timestamp</th>
                                <th class="p-3 border-b border-slate-200">Responden</th>
                                <th class="p-3 border-b border-slate-200">Mimpi Sekolah</th>
                                <th class="p-3 border-b border-slate-200">Kondisi Baik</th>
                                <th class="p-3 border-b border-slate-200">Indikator Baik</th>
                                <th class="p-3 border-b border-slate-200">Penyebab Baik</th>
                                <th class="p-3 border-b border-slate-200">Kondisi Buruk</th>
                                <th class="p-3 border-b border-slate-200">Indikator Buruk</th>
                                <th class="p-3 border-b border-slate-200">Penyebab Buruk</th>
                                <th class="p-3 border-b border-slate-200">Kelebihan Diri</th>
                                <th class="p-3 border-b border-slate-200">Kelemahan Diri</th>
                                <th class="p-3 border-b border-slate-200">Upaya Personal</th>
                                <th class="p-3 border-b border-slate-200">Komitmen</th>
                                <th class="p-3 border-b border-slate-200">Konsekuensi</th>
                            </tr>
                        </thead>
                        <tbody id="db-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <!-- Firebase & Analysis Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyC6IXCk6EXm0ndord8Is6cRZf_mG2MY5UM",
            authDomain: "kedinasan-d9051.firebaseapp.com",
            projectId: "kedinasan-d9051",
            storageBucket: "kedinasan-d9051.firebasestorage.app",
            messagingSenderId: "488517479224",
            appId: "1:488517479224:web:57ed244cf69e2a010c6fcd"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sdn-perdana-app';
        const apiKey = ""; // Gemini API Key

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const employees = [
            { name: "Neneng Imas Kurnia", prefix: "Ibu" },
            { name: "Ujang Edi Brata", prefix: "Bapak" },
            { name: "Asep Ruhbi", prefix: "Bapak" },
            { name: "Uju Juaenah", prefix: "Ibu" },
            { name: "Bahtiar Arifin", prefix: "Bapak" },
            { name: "Cupang Sulastri", prefix: "Ibu" },
            { name: "Kamjah", prefix: "Bapak" },
            { name: "Iis Isnayah", prefix: "Ibu" },
            { name: "Rini Lestari", prefix: "Ibu" },
            { name: "Novianti", prefix: "Ibu" },
            { name: "Ahmad Sanusi", prefix: "Bapak" },
            { name: "Samsudin", prefix: "Bapak" }
        ];

        let database = [];
        let isAdmin = localStorage.getItem('admin_sdn_active') === 'true';
        const reflectionsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'reflections');

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) { console.error("Auth error:", error); }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                onSnapshot(reflectionsCollection, (snapshot) => {
                    database = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderDashboard();
                    if (!document.getElementById('content-database').classList.contains('hidden')) {
                        renderDatabase();
                    }
                }, (error) => { console.error("Firestore sync error:", error); });
            }
        });

        window.onload = async () => {
            await initAuth();
            if (isAdmin) applyAdminState();
            resetPrefixedInputs();
            renderDashboard();
        };

        function resetPrefixedInputs() {
            const fc = document.getElementById('final_commitment');
            if (fc) fc.value = "Saya berjanji ";
        }

        window.openLoginModal = () => document.getElementById('login-modal').classList.remove('hidden');
        window.closeLoginModal = () => document.getElementById('login-modal').classList.add('hidden');
        window.togglePasswordVisibility = () => {
            const pwd = document.getElementById('admin-password');
            const icon = document.getElementById('eye-icon');
            pwd.type = pwd.type === "password" ? "text" : "password";
        };

        window.processLogin = () => {
            if (document.getElementById('admin-password').value === "EdiBrata#1") {
                isAdmin = true;
                if (document.getElementById('remember-me').checked) localStorage.setItem('admin_sdn_active', 'true');
                applyAdminState();
                window.closeLoginModal();
                alert("Login Admin Berhasil.");
            } else { alert("Password Salah."); }
        };

        function applyAdminState() {
            document.getElementById('tab-database').classList.remove('hidden');
            document.getElementById('btn-login-admin').classList.add('hidden');
            document.getElementById('btn-logout-admin').classList.remove('hidden');
            for (let i = 1; i <= 6; i++) {
                const sec = document.getElementById(`sec-${i}`);
                if (sec) sec.classList.remove('card-disabled');
            }
            document.getElementById('sub-3b').classList.remove('sub-disabled');
            document.getElementById('btn-sec-3-final').classList.remove('hidden');
            document.getElementById('btn-sec-5-final').classList.remove('hidden');
        }

        window.logoutAdmin = () => {
            localStorage.removeItem('admin_sdn_active');
            location.reload();
        };

        // AI Analysis Logic
        async function fetchAIAnalysis(data, sectionName) {
            const prompt = `Anda adalah konsultan pendidikan profesional. Analisislah data refleksi kolektif dari guru dan staf di SDN Perdana berikut ini untuk bagian "${sectionName}". 
            Tugas Anda:
            1. Identifikasi pola utama dari semua isian kolektif.
            2. Berikan kesimpulan deskriptif yang mendalam.
            3. Berikan saran strategis untuk sekolah.
            
            Data Isian Kolektif:
            ${JSON.stringify(data)}
            
            Gunakan bahasa Indonesia yang profesional, empatik, dan membangun. Format jawaban dalam paragraf yang rapi.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "Berikan analisis data yang mendalam dan solutif." }] }
            };

            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "Gagal menghasilkan analisis.";
                } catch (e) {
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
            return "Terjadi kesalahan pada layanan AI.";
        }

        window.triggerAI = async (id, sectionKey, sectionName) => {
            const display = document.getElementById(`ai-box-${id}`);
            display.innerHTML = `<div class="p-4 flex items-center space-x-3 text-blue-600"><svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="text-sm font-bold">AI sedang menyusun analisis deskriptif...</span></div>`;
            
            const rawData = database.map(d => {
                if (typeof sectionKey === 'string') return d[sectionKey];
                return sectionKey.map(k => k.split('.').reduce((o, i) => o[i], d)).join(" | ");
            });

            const analysis = await fetchAIAnalysis(rawData, sectionName);
            display.innerHTML = `<div class="p-5 bg-blue-50/50 rounded-xl border border-blue-100 text-sm leading-relaxed text-slate-700 whitespace-pre-wrap"><div class="font-bold text-blue-700 mb-2 flex items-center"><svg class="h-4 w-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zM7 10a1 1 0 01-1 1H5a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM9 11l.012 2.012c.03.762.534 1.456 1.251 1.737L13 16l-2.737.749a2.001 2.001 0 00-1.251 1.737L9 20.5l-.012-2.012a2.001 2.001 0 00-1.251-1.737L5 16l2.737-.749a2.001 2.001 0 001.251-1.737L9 11z"/></svg> Kesimpulan Deskriptif & Saran Strategis AI</div>${analysis}</div>`;
        };

        window.renderDashboard = () => {
            document.getElementById('stat-count').textContent = database.length;
            const container = document.getElementById('collective-analysis-container');
            if (!container) return;
            container.innerHTML = "";
            if (database.length === 0) return;

            const sections = [
                { id: "vision", title: "Mimpi & Harapan Kolektif", key: "vision" },
                { id: "cond", title: "Potret Kondisi Sekolah (Lengkap)", keys: ["condition.good", "condition.good_ind", "condition.good_cause", "condition.bad", "condition.bad_ind", "condition.bad_cause"] },
                { id: "personal", title: "Refleksi Kinerja Individu Kolektif", keys: ["self.strength", "self.weakness", "self.effort"] },
                { id: "comm", title: "Komitmen & Konsekuensi Kolektif", keys: ["commitment", "consequence"] }
            ];

            sections.forEach(s => {
                const acc = document.createElement('details');
                acc.className = "card border shadow-sm group";
                acc.innerHTML = `
                    <summary class="flex items-center justify-between p-6 cursor-pointer bg-white group-open:bg-slate-50 transition-all">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center text-blue-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                            </div>
                            <h3 class="font-bold text-slate-800 uppercase tracking-tight text-sm">${s.title}</h3>
                        </div>
                        <svg class="h-5 w-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <div class="p-6 pt-2 border-t space-y-4">
                        <div class="space-y-3">
                            ${database.map((entry, i) => `
                                <div class="p-4 bg-white border border-slate-100 rounded-xl text-[11px] text-slate-600 italic leading-relaxed shadow-sm">
                                    <div class="mb-2 text-[10px] font-bold text-blue-800 not-italic uppercase tracking-widest opacity-50">Isian Responden #${i+1}</div>
                                    ${s.key ? entry[s.key] : s.keys.map(k => {
                                        const v = k.split('.').reduce((o, i) => o[i], entry);
                                        const label = k.split('.').pop().replace('_', ' ').toUpperCase();
                                        return `<div class="mb-2"><span class="font-bold text-slate-800 block not-italic text-[10px] mb-0.5">${label}:</span> ${v}</div>`;
                                    }).join("")}
                                </div>
                            `).join("")}
                        </div>
                        <div id="ai-box-${s.id}" class="mt-6 pt-4 border-t border-slate-100">
                            <button onclick="window.triggerAI('${s.id}', ${JSON.stringify(s.key || s.keys)}, '${s.title}')" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700 ai-glow">
                                <svg class="h-3 w-3 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1a1 1 0 112 0v1a1 1 0 11-2 0zm6-1a1 1 0 10-2 0v1a1 1 0 102 0v-1zM3.05 13l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm13.89 0l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414z" /></svg>
                                GENERATE ANALISIS DESKRIPTIF AI
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(acc);
            });

            // 360 Analysis - Now also Accordion per Employee
            const peerHeading = document.createElement('div');
            peerHeading.className = "pt-6 pb-2 border-t mt-10";
            peerHeading.innerHTML = `<h3 class="text-lg font-black text-slate-800 uppercase tracking-tighter">Analisis Refleksi 360° (Per Pegawai)</h3>`;
            container.appendChild(peerHeading);
            
            employees.forEach(emp => {
                const reviews = database.map(d => d.peerReviews?.[emp.name]).filter(r => r && r.strength);
                if (reviews.length > 0) {
                    const id = emp.name.replace(/\s+/g, '_');
                    const acc360 = document.createElement('details');
                    acc360.className = "card border shadow-sm group mb-3";
                    acc360.innerHTML = `
                        <summary class="flex items-center justify-between p-4 cursor-pointer bg-white group-open:bg-emerald-50 transition-all">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 rounded-lg bg-emerald-600 flex items-center justify-center text-white font-black text-[10px]">${emp.name.split(' ').map(n=>n[0]).join('')}</div>
                                <div>
                                    <div class="text-xs font-bold text-slate-800">${emp.name}</div>
                                    <div class="text-[9px] font-medium text-slate-400 uppercase tracking-widest">${reviews.length} Rekan Memberi Nilai</div>
                                </div>
                            </div>
                            <svg class="h-4 w-4 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </summary>
                        <div class="p-6 pt-4 border-t space-y-8">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="space-y-3">
                                    <h5 class="text-[9px] font-black text-emerald-700 uppercase tracking-widest bg-emerald-50 px-3 py-1 rounded-full inline-block">Kelebihan</h5>
                                    <div class="space-y-2">${reviews.map(r => `<div class="p-3 bg-slate-50 rounded-lg text-[10px] italic border-l-2 border-emerald-500">${r.strength}</div>`).join("")}</div>
                                </div>
                                <div class="space-y-3">
                                    <h5 class="text-[9px] font-black text-amber-700 uppercase tracking-widest bg-amber-50 px-3 py-1 rounded-full inline-block">Kelemahan</h5>
                                    <div class="space-y-2">${reviews.map(r => `<div class="p-3 bg-slate-50 rounded-lg text-[10px] italic border-l-2 border-amber-500">${r.weakness}</div>`).join("")}</div>
                                </div>
                                <div class="space-y-3">
                                    <h5 class="text-[9px] font-black text-blue-700 uppercase tracking-widest bg-blue-50 px-3 py-1 rounded-full inline-block">Harapan</h5>
                                    <div class="space-y-2">${reviews.map(r => `<div class="p-3 bg-slate-50 rounded-lg text-[10px] italic border-l-2 border-blue-500">${r.hope}</div>`).join("")}</div>
                                </div>
                            </div>
                            <div id="ai-box-360-${id}" class="mt-4 pt-4 border-t border-slate-100">
                                <button onclick="window.triggerAI('360-${id}', ${JSON.stringify(reviews)}, 'Refleksi 360 Untuk ${emp.name}')" class="flex items-center px-4 py-2 bg-emerald-600 text-white rounded-lg text-[10px] font-bold hover:bg-emerald-700 ai-glow">
                                    KESIMPULAN AI UNTUK ${emp.name.toUpperCase()}
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(acc360);
                }
            });
        };

        window.renderDatabase = () => {
            const tbody = document.getElementById('db-body');
            if (!tbody) return;
            tbody.innerHTML = database.length ? '' : '<tr><td colspan="15" class="p-10 text-center italic text-slate-400 font-medium">Belum ada data refleksi masuk.</td></tr>';
            database.slice().reverse().forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors";
                tr.innerHTML = `
                    <td class="p-3 border-b text-slate-400 font-medium">${database.length - idx}</td>
                    <td class="p-3 border-b text-[9px] text-slate-400 whitespace-nowrap">${row.timestamp}</td>
                    <td class="p-3 border-b font-bold text-slate-800">${row.user}</td>
                    <td class="p-3 border-b text-slate-500 italic max-w-[150px] truncate" title="${row.vision}">${row.vision}</td>
                    <td class="p-3 border-b text-slate-500 max-w-[150px] truncate" title="${row.condition.good}">${row.condition.good}</td>
                    <td class="p-3 border-b text-slate-500 max-w-[150px] truncate" title="${row.condition.good_ind}">${row.condition.good_ind}</td>
                    <td class="p-3 border-b text-slate-500 max-w-[150px] truncate" title="${row.condition.good_cause}">${row.condition.good_cause}</td>
                    <td class="p-3 border-b text-slate-500 max-w-[150px] truncate" title="${row.condition.bad}">${row.condition.bad}</td>
                    <td class="p-3 border-b text-slate-500 max-w-[150px] truncate" title="${row.condition.bad_ind}">${row.condition.bad_ind}</td>
                    <td class="p-3 border-b text-slate-500 max-w-[150px] truncate" title="${row.condition.bad_cause}">${row.condition.bad_cause}</td>
                    <td class="p-3 border-b text-slate-500 max-w-[150px] truncate" title="${row.self.strength}">${row.self.strength}</td>
                    <td class="p-3 border-b text-slate-500 max-w-[150px] truncate" title="${row.self.weakness}">${row.self.weakness}</td>
                    <td class="p-3 border-b text-slate-500 max-w-[150px] truncate" title="${row.self.effort}">${row.self.effort}</td>
                    <td class="p-3 border-b text-slate-500 max-w-[150px] truncate" title="${row.commitment}">${row.commitment}</td>
                    <td class="p-3 border-b text-slate-500 max-w-[150px] truncate" title="${row.consequence}">${row.consequence}</td>
                `;
                tbody.appendChild(tr);
            });
        };

        // Standard Utility Functions (Next, Validations, etc)
        window.validateAndNext = (n) => {
            const sec = document.getElementById(`sec-${n}`);
            if (!isAdmin) {
                const visibleInputs = Array.from(sec.querySelectorAll('.comp-input, select[required]')).filter(i => !i.closest('.hidden'));
                let valid = true;
                visibleInputs.forEach(i => { 
                    if (i.tagName === 'TEXTAREA' && i.value.trim().length < parseInt(i.dataset.min)) valid = false; 
                    else if (!i.value) valid = false; 
                });
                if (!valid) { alert("Isian bagian ini belum komprehensif atau belum lengkap."); return; }
            }
            sec.removeAttribute('open');
            const badge = document.getElementById(`badge-${n}`);
            badge.classList.replace('status-incomplete', 'status-complete');
            document.getElementById(`num-${n}`).classList.add('hidden');
            badge.querySelector('path').classList.remove('hidden');
            const next = document.getElementById(`sec-${n + 1}`);
            if (next) { next.classList.remove('card-disabled'); next.setAttribute('open', ''); next.scrollIntoView({ behavior: 'smooth' }); }
        };

        window.validateSub = (sec, part) => {
            const sub = document.getElementById(`sub-${sec}${part}`);
            const tas = sub.querySelectorAll('.comp-input');
            let valid = true;
            tas.forEach(ta => { if (ta.value.trim().length < parseInt(ta.dataset.min)) valid = false; });
            if (valid || isAdmin) {
                sub.removeAttribute('open');
                if (part === 'a') { document.getElementById(`sub-${sec}b`).classList.remove('sub-disabled'); document.getElementById(`sub-${sec}b`).setAttribute('open', ''); }
                else { document.getElementById('btn-sec-3-final').classList.remove('hidden'); }
            } else { alert("Isian belum memenuhi syarat komprehensif."); }
        };

        window.validatePeer = (id) => {
            const tas = document.getElementById(`item-${id}`).querySelectorAll('.comp-input');
            let valid = true;
            tas.forEach(ta => { if (ta.value.trim().length < parseInt(ta.dataset.min)) valid = false; });
            if (valid || isAdmin) {
                document.getElementById(`peer-status-${id}`).classList.replace('bg-slate-300', 'bg-green-500');
                document.getElementById(`item-${id}`).removeAttribute('open');
                let next = document.getElementById(`item-${id}`).nextElementSibling;
                while (next && next.classList.contains('hidden')) next = next.nextElementSibling;
                if (next) { next.classList.remove('sub-disabled'); next.setAttribute('open', ''); }
                else { document.getElementById('btn-sec-5-final').classList.remove('hidden'); }
            } else { alert("Isian penilaian rekan belum komprehensif."); }
        };

        window.filterPeerReview = () => {
            const user = document.getElementById('user_name').value;
            employees.forEach(emp => {
                const id = emp.name.replace(/\s+/g, '_');
                const el = document.getElementById(`item-${id}`);
                const isSelf = emp.name === user;
                el.classList.toggle('hidden', isSelf);
                el.querySelectorAll('textarea').forEach(ta => { ta.required = !isSelf; });
                if (!isAdmin && emp.name !== user && el.previousElementSibling?.classList.contains('hidden')) el.classList.remove('sub-disabled');
            });
        };

        window.switchTab = (tab) => {
            ['form', 'dashboard', 'database'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.replace('tab-active', 'tab-inactive');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.replace('tab-inactive', 'tab-active');
            if (tab === 'dashboard') renderDashboard();
            if (tab === 'database') renderDatabase();
        };

        // Submit to Cloud
        document.getElementById('masterForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btnSubmit = document.getElementById('btn-submit-all');
            const originalText = btnSubmit.innerHTML;
            try {
                if (isAdmin) { alert("Mode Review Admin: Pengiriman tidak diproses."); return; }
                if (!auth.currentUser) { alert("Tunggu otentikasi..."); return; }
                btnSubmit.disabled = true;
                btnSubmit.innerHTML = "<span>Menyimpan ke Cloud...</span>";
                const current = document.getElementById('user_name').value;
                const peers = {};
                employees.forEach(emp => {
                    if (emp.name !== current) {
                        const id = emp.name.replace(/\s+/g, '_');
                        peers[emp.name] = {
                            strength: document.querySelector(`[name="strength_${id}"]`).value,
                            weakness: document.querySelector(`[name="weakness_${id}"]`).value,
                            hope: document.querySelector(`[name="hope_${id}"]`).value
                        };
                    }
                });
                const reflectionData = {
                    user: current,
                    vision: document.getElementById('self_vision').value,
                    condition: { 
                        good: document.getElementById('cond_good').value, 
                        bad: document.getElementById('cond_bad').value,
                        good_ind: document.getElementById('cond_good_indicator').value,
                        bad_ind: document.getElementById('cond_bad_indicator').value,
                        good_cause: document.getElementById('cond_good_cause').value,
                        bad_cause: document.getElementById('cond_bad_cause').value
                    },
                    self: { 
                        strength: document.getElementById('self_strength').value, 
                        weakness: document.getElementById('self_weakness').value, 
                        effort: document.getElementById('self_effort').value 
                    },
                    peerReviews: peers,
                    commitment: document.getElementById('final_commitment').value,
                    consequence: document.getElementById('final_consequence').value,
                    timestamp: new Date().toLocaleString(),
                    createdAt: Date.now()
                };
                await addDoc(reflectionsCollection, reflectionData);
                alert("Data Refleksi Berhasil Disimpan di Cloud!");
                location.reload();
            } catch (error) {
                console.error(error);
                alert("Gagal: " + error.message);
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = originalText;
            }
        });

        // Export Scripts
        window.exportToExcel = () => {
            const wsData = database.map((d, i) => ({
                "No": i + 1, "Timestamp": d.timestamp, "Nama Responden": d.user, "Mimpi Sekolah": d.vision,
                "Kondisi Baik": d.condition.good, "Indikator Baik": d.condition.good_ind, "Penyebab Baik": d.condition.good_cause,
                "Kondisi Buruk": d.condition.bad, "Indikator Buruk": d.condition.bad_ind, "Penyebab Buruk": d.condition.bad_cause,
                "Kelebihan Diri": d.self.strength, "Kelemahan Diri": d.self.weakness, "Upaya Personal": d.self.effort,
                "Komitmen": d.commitment, "Konsekuensi": d.consequence
            }));
            const ws = XLSX.utils.json_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Database Refleksi");
            XLSX.writeFile(wb, "Rekap_Lengkap_Refleksi_SDN_Perdana.xlsx");
        };

        window.exportToPDF = async () => {
            const { jsPDF } = window.jspdf;
            const docPdf = new jsPDF('l', 'pt', 'a4');
            docPdf.setFontSize(14);
            docPdf.text("Rekapitulasi Lengkap Refleksi Kinerja SDN Perdana", 40, 40);
            const headers = [["No", "Timestamp", "Nama", "Mimpi", "Baik", "Buruk", "Komitmen"]];
            const data = database.map((d, i) => [i + 1, d.timestamp, d.user, d.vision.substring(0, 40)+'...', d.condition.good.substring(0, 40)+'...', d.condition.bad.substring(0, 40)+'...', d.commitment.substring(0, 40)+'...']);
            docPdf.autoTable({ head: headers, body: data, startY: 60, theme: 'grid', styles: { fontSize: 7 } });
            docPdf.save("Rekap_Refleksi_Lengkap.pdf");
        };

        window.backupJSON = () => {
            const blob = new Blob([JSON.stringify(database, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `backup_sdn_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        };

        window.restoreJSON = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (confirm("Restore data akan menambah data ke Cloud. Lanjutkan?")) {
                        for (const item of data) { delete item.id; await addDoc(reflectionsCollection, item); }
                        alert("Restore berhasil.");
                    }
                } catch (err) { alert("Format file tidak valid."); }
            };
            reader.readAsText(file);
        };

        window.clearAll = async () => {
            if (confirm("Hapus seluruh database di Cloud? Tindakan ini permanen.")) {
                try {
                    const promises = database.map(row => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reflections', row.id)));
                    await Promise.all(promises); alert("Database dibersihkan.");
                } catch (error) { console.error(error); }
            }
        };
    </script>
</body>
</html>
